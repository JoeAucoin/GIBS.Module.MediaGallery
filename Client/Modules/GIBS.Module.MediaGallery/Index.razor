@using GIBS.Module.MediaGallery.Services
@using GIBS.Module.MediaGallery.Models
@using System.Text.Json
@using Microsoft.AspNetCore.Components

@namespace GIBS.Module.MediaGallery
@inherits ModuleBase
@inject IMediaGalleryCategoryService MediaGalleryCategoryService
@inject IMediaGalleryItemService MediaGalleryItemService
@inject ITagsService TagsService
@inject IItemTagsService ItemTagsService
@inject NavigationManager NavigationManager
@inject ISettingService SettingService
@inject IStringLocalizer<Index> Localizer



@if (_categoryId == -1)
{
    @if (_albums == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="text-end">
            <ActionLink Action="ManageGallery" Security="SecurityAccessLevel.Edit" Text="Manage Gallery" ResourceKey="ManageGallery" />
        </div>
        <br />
        <br />
        @if (_albums.Count != 0)
        {
           <div class="piwigo-gallery" id="piwigoGallery">
           
            <div class="pw-albums-grid">
                @foreach (var album in _albums)
                {
                    <div class="pw-album-card" @onclick="async () => await ViewAlbum(album.CategoryId)">
                        <div class="pw-album-thumb">
                                <img class="pw-album-img" src="@album.ThumbnailPath" alt="@album.CategoryName" loading="lazy" />
                            <div class="pw-album-overlay"></div>
                        </div>
                        <div class="pw-album-info">
                            <h1 class="pw-album-title">@album.CategoryName</h1>
                            <span class="pw-album-count">@album.ItemCount photos</span>
                        </div>
                    </div>
                }
            </div>
            </div>
        }
        else
        {
            <p>@Localizer["Message.DisplayNone"]</p>
        }
    }
}
else
{
    <div class="container">
        
        <div class="row">
            <div class="col-md-10">
                <h3>@_selectedCategoryName</h3> 
            </div>
            <div class="col-md-2 text-end"><button class="btn btn-secondary mb-3" @onclick="async () => await ShowAlbums()">Back to Albums</button></div>
        </div>

        @if (_categoryId != -1 && _tagCounts != null && _tagCounts.Any())
        {
            <div class="container mt-1 mb-3 p-3" style="border: 1px solid #ddd; border-radius: 5px;">
                <div class="row">
                    <div class="col">
                        <span class="fw-bold"><i class="oi oi-tag"></i> Filter by Tag:</span>&nbsp;&nbsp;
                        @foreach (var tag in _tagCounts)
                        {
                            var btnClass = (_selectedTag == tag.Key) ? "btn-primary" : "btn-outline-secondary";
                            <button class="btn btn-sm rounded-pill me-1 mb-1 @btnClass" @onclick="() => FilterByTag(tag.Key)">
                                @tag.Key (@tag.Value)
                            </button>

                        }
                        &nbsp;
                        @if (!string.IsNullOrEmpty(_selectedTag))
                        {
                            <button class="btn btn-sm btn-link text-danger" @onclick="ClearTagFilter">Clear Filter</button>
                        }
                    </div>
                </div>
            </div>
        }


        <div class="pw-photos-grid" id="photosGrid">
            @if (_items == null)
            {
                <p><em>Loading items...</em></p>
            }
            else
            {
                @foreach (var item in _items)
                {
                    <div class="pw-photo-item" @onclick="() => OpenLightbox(item)">
                        <img src="@item.ThumbnailPath" alt="@item.Title - @item.CategoryName" class="pw-photo-img" loading="lazy" />
                        <div class="pw-item-overlay">
                            <div class="pw-item-info">
                                @if (_showPhotoTitle)
                                {
                                    <h2 class="pw-item-title">@item.Title</h2>
                                }

                            </div>
                        </div>
                       
                    </div>
                }
            }
        </div>
    </div>
}


@if (_showLightbox)
{
    <div class="pw-lightbox-overlay" @onclick="CloseLightbox">
        <div class="pw-lightbox-container">
            <button class="pw-lightbox-close" @onclick="CloseLightbox" @onclick:stopPropagation="true">&times;</button>

            @if (_items.IndexOf(_selectedItem) > 0)
            {
                <div class="pw-lightbox-nav pw-lightbox-nav-prev" @onclick="ShowPrevious" @onclick:stopPropagation="true">
                    <button class="pw-lightbox-prev"><i class="oi oi-arrow-circle-left" style="font-size: 24px;"></i></button>
                </div>
            }

            <div class="pw-lightbox-content" @onclick:stopPropagation="true">
                <img src="@_selectedItem.FilePath" alt="@_selectedItem.Title" />
            </div>

            @if (_items.IndexOf(_selectedItem) < _items.Count - 1)
            {
                <div class="pw-lightbox-nav pw-lightbox-nav-next" @onclick="ShowNext" @onclick:stopPropagation="true">
                    <button class="pw-lightbox-next"><i class="oi oi-arrow-circle-right" style="font-size: 24px;"></i></button>
                </div>
            }

            <div class="pw-lightbox-info">
                <h3 class="pw-lightbox-title">@_selectedItem.Title</h3>
                @if (!string.IsNullOrEmpty(_selectedItem.Tags))
                {
                    <div class="pw-lightbox-description">@_selectedItem.Tags</div>
                }
                <span class="pw-lightbox-counter">@(_items.IndexOf(_selectedItem) + 1) / @_items.Count</span>
            </div>
        </div>
    </div>
}


@code {
    public override string RenderMode => RenderModes.Interactive;

    public override List<Resource> Resources => new List<Resource>()
    {
        new Resource { ResourceType = ResourceType.Stylesheet, Url = "_content/GIBS.Module.MediaGallery/Module.css?v=1.9" },
       // new Resource { ResourceType = ResourceType.Script, Url = ModulePath() + "Module.js" }
    };

    private List<MediaGalleryAlbum> _albums;
    private List<MediaGalleryItem> _items;
    private List<MediaGalleryItem> _categoryItems;
    private List<Models.Tags> _tags;
    private Dictionary<string, int> _tagCounts;
    private string _selectedTag;
    private int _categoryId = -1;
    private string _selectedCategoryName;
    private bool _showLightbox = false;
    private MediaGalleryItem _selectedItem;
    private bool _showPhotoTitle;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);
            _showPhotoTitle = bool.Parse(SettingService.GetSetting(settings, "ShowPhotoTitle", "true"));
            await LoadAlbums();
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Loading Gallery {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.LoadError"], MessageType.Error);
        }
    }

    private async Task LoadAlbums()
    {
        _albums = await MediaGalleryItemService.GetMediaGalleryAlbumsAsync(ModuleState.ModuleId);
        
    }

    private async Task LoadTags()
    {
        _tags = await TagsService.GetTagsAsync(ModuleState.ModuleId);
    }

    private async Task LoadCategoryItems()
    {
        var allItems = await MediaGalleryItemService.GetMediaGalleryItemsAsync(ModuleState.ModuleId);
        _categoryItems = allItems.Where(i => i.CategoryId == _categoryId).OrderBy(i => i.SortOrder).ToList();
        if (_categoryItems.Any())
        {
            _selectedCategoryName = _categoryItems.First().CategoryName;
            await LoadTags();
            if (_tags != null)
            {
                foreach (var item in _categoryItems)
                {
                    var itemTags = await ItemTagsService.GetItemTagsAsync(item.ItemId);
                    if (itemTags != null && itemTags.Any())
                    {
                        var tagNames = new List<string>();
                        foreach (var itemTag in itemTags)
                        {
                            var tag = _tags.FirstOrDefault(t => t.TagId == itemTag.TagId);
                            if (tag != null)
                            {
                                tagNames.Add(tag.TagName);
                            }
                        }
                        item.Tags = string.Join(", ", tagNames);
                    }
                }
            }

            _tagCounts = _categoryItems
                .Where(i => !string.IsNullOrEmpty(i.Tags))
                .SelectMany(i => i.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Select(t => t.Trim()))
                .GroupBy(t => t)
                .OrderBy(g => g.Key)
                .ToDictionary(g => g.Key, g => g.Count());
        }
        else
        {
            // If category is empty, still try to get its name
            var category = await MediaGalleryCategoryService.GetMediaGalleryCategoryAsync(_categoryId, ModuleState.ModuleId);
            _selectedCategoryName = category?.CategoryName ?? "Album";
            _categoryItems = new List<MediaGalleryItem>();
            _tagCounts = new Dictionary<string, int>();
        }

        _items = new List<MediaGalleryItem>(_categoryItems);
        _selectedTag = null;
        
    }

    private void FilterByTag(string tagName)
    {
        if (_selectedTag == tagName)
        {
            // If the same tag is clicked again, clear the filter
            ClearTagFilter();
        }
        else
        {
            _selectedTag = tagName;
            _items = _categoryItems.Where(i =>
                !string.IsNullOrEmpty(i.Tags) &&
                i.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                      .Select(t => t.Trim())
                      .Contains(_selectedTag))
                .ToList();
        }
        StateHasChanged();
    }

    private void ClearTagFilter()
    {
        _selectedTag = null;
        _items = new List<MediaGalleryItem>(_categoryItems);
        StateHasChanged();
    }

    private async Task ViewAlbum(int categoryId)
    {
        _categoryId = categoryId;
        await LoadCategoryItems();
        StateHasChanged();
    }

    private async Task ShowAlbums()
    {
        _categoryId = -1;
        _items = null;
       
        StateHasChanged();
    }

    private void OpenLightbox(MediaGalleryItem item)
    {
        _selectedItem = item;
        _showLightbox = true;
        StateHasChanged();
    }

    private void CloseLightbox()
    {
        _showLightbox = false;
        _selectedItem = null;
        StateHasChanged();
    }

    private void ShowNext()
    {
        int currentIndex = _items.FindIndex(i => i.ItemId == _selectedItem.ItemId);
        if (currentIndex < _items.Count - 1)
        {
            _selectedItem = _items[currentIndex + 1];
            StateHasChanged();
        }
    }

    private void ShowPrevious()
    {
        int currentIndex = _items.FindIndex(i => i.ItemId == _selectedItem.ItemId);
        if (currentIndex > 0)
        {
            _selectedItem = _items[currentIndex - 1];
            StateHasChanged();
        }
    }

}